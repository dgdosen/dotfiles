#!/usr/bin/env bash

# Theme switcher for terminal environment
# Usage: switch-theme <theme-name>
#   or set TERMINAL_THEME env variable
#
# Available themes:
#   - catppuccin-mocha
#   - catppuccin-latte
#   - gruvbox-dark (gruvbox_dark)
#   - gruvbox-light (gruvbox_light)

set -e

DOTFILES="${HOME}/.dotfiles"

# Get theme from argument or env variable
THEME="${1:-${TERMINAL_THEME}}"

if [ -z "$THEME" ]; then
  echo "Usage: switch-theme <theme-name>"
  echo "  or set TERMINAL_THEME environment variable"
  echo ""
  echo "Available themes:"
  echo "  - catppuccin-mocha"
  echo "  - catppuccin-latte"
  echo "  - gruvbox-dark"
  echo "  - gruvbox-light"
  exit 1
fi

# Normalize theme names (handle both gruvbox-dark and gruvbox_dark)
case "$THEME" in
  gruvbox-dark) THEME="gruvbox_dark" ;;
  gruvbox-light) THEME="gruvbox_light" ;;
esac

# Validate theme exists
ALACRITTY_THEME="${DOTFILES}/.config/alacritty/themes/${THEME}.toml"
if [ ! -f "$ALACRITTY_THEME" ]; then
  echo "Error: Theme '$THEME' not found at $ALACRITTY_THEME"
  exit 1
fi

echo "Switching to theme: $THEME"

# Update Alacritty
echo "  ✓ Alacritty"
ln -sf "themes/${THEME}.toml" "${DOTFILES}/.config/alacritty/current-theme.toml"
touch "${DOTFILES}/.config/alacritty/alacritty.toml"

# Update Neovim
echo "  ✓ Neovim"
echo "${THEME}" > "${DOTFILES}/.nvim-theme"

# Map theme to nvim colorscheme
NVIM_COLORSCHEME=""
case "$THEME" in
  gruvbox_dark|gruvbox_light)
    NVIM_COLORSCHEME="gruvbox"
    ;;
  catppuccin-mocha)
    NVIM_COLORSCHEME="catppuccin-mocha"
    ;;
  catppuccin-latte)
    NVIM_COLORSCHEME="catppuccin-latte"
    ;;
esac

# Send colorscheme command to running nvim instances in tmux
if command -v tmux &> /dev/null && tmux list-panes -a -F '#{pane_id} #{pane_current_command}' 2>/dev/null | grep -q nvim; then
  # Set background for gruvbox
  if [[ "$THEME" == "gruvbox_light" ]]; then
    tmux list-panes -a -F '#{pane_id} #{pane_current_command}' | grep nvim | awk '{print $1}' | while read pane; do
      tmux send-keys -t "$pane" Escape
      tmux send-keys -t "$pane" ":set background=light" Enter
      tmux send-keys -t "$pane" ":colorscheme ${NVIM_COLORSCHEME}" Enter
    done
  else
    tmux list-panes -a -F '#{pane_id} #{pane_current_command}' | grep nvim | awk '{print $1}' | while read pane; do
      tmux send-keys -t "$pane" Escape
      tmux send-keys -t "$pane" ":set background=dark" Enter
      tmux send-keys -t "$pane" ":colorscheme ${NVIM_COLORSCHEME}" Enter
    done
  fi
  echo "    → Updated running nvim instances"
fi

# Update Tmux
echo "  ✓ Tmux"
# Map theme names to tmux theme names
TMUX_THEME=""
case "$THEME" in
  gruvbox_dark)
    TMUX_THEME="gruvbox-dark"
    ;;
  gruvbox_light)
    TMUX_THEME="gruvbox-light"
    ;;
  catppuccin-mocha)
    TMUX_THEME="catppuccin-mocha"
    ;;
  catppuccin-latte)
    TMUX_THEME="catppuccin-latte"
    ;;
esac

echo "set -g @theme \"${TMUX_THEME}\"" > "${DOTFILES}/.tmux-theme"

# Reload tmux config if tmux is running
if command -v tmux &> /dev/null && tmux list-sessions &>/dev/null 2>&1; then
  tmux source-file ~/.tmux.conf
  echo "    → Reloaded tmux config"
fi

# TODO: Add p10k switching

echo "Theme switched successfully!"
echo "Note: Alacritty windows will reload automatically"
